<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSLSA | Official Management & Verification Portal</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        .gov-navy { background-color: #002147; }
        .hero-gradient { background: linear-gradient(135deg, #002147 0%, #003366 100%); }
        
        @media print {
            body * { visibility: hidden; }
            #printSection, #printSection * { visibility: visible; }
            #printSection { position: absolute; left: 0; top: 0; width: 100%; display: block !important; border: none !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <nav class="bg-white border-b-4 border-orange-500 sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 h-20 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="bg-blue-900 text-white p-2 rounded-lg"><i class="fas fa-monument text-2xl"></i></div>
                <div>
                    <h1 class="text-xl font-black text-blue-900 leading-none uppercase">TSLSA</h1>
                    <p class="text-[10px] uppercase tracking-widest text-slate-400 font-bold">Telangana State Licensed Surveyors Association</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <button id="loginBtn" onclick="openAuth()" class="text-[10px] font-black uppercase border-2 border-blue-900 px-4 py-2 rounded-xl hover:bg-blue-900 hover:text-white transition">Staff Login</button>
            </div>
        </div>
    </nav>

    <header class="hero-gradient text-white py-16">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <h2 class="text-4xl font-black mb-4 tracking-tight uppercase">Registry Management System</h2>
            <p id="modeIndicator" class="text-blue-200 text-sm font-bold uppercase tracking-widest">Public Verification Mode</p>
        </div>
    </header>

    <div id="adminModal" class="hidden fixed inset-0 bg-blue-900/90 z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-3xl p-8 relative shadow-2xl">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-slate-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            
            <div id="authStep">
                <h2 class="text-2xl font-black text-blue-900 mb-6 uppercase">Admin Access</h2>
                <input type="password" id="staffPass" placeholder="Enter System Password" class="w-full p-4 bg-slate-100 rounded-2xl mb-4 outline-none border-2 focus:border-blue-900">
                <button onclick="verifyPassword()" class="w-full bg-blue-900 text-white font-black py-4 rounded-2xl uppercase tracking-widest">Verify</button>
            </div>

            <div id="entryStep" class="hidden">
                <div class="flex border-b mb-6 text-xs font-black uppercase tracking-widest">
                    <button onclick="switchTab('form')" id="tabBtnForm" class="flex-1 pb-3 border-b-2 border-blue-900">Entry Form</button>
                    <button onclick="switchTab('log')" id="tabBtnLog" class="flex-1 pb-3 border-b-2 border-transparent text-slate-400">Audit Log</button>
                </div>
                <div id="adminFormArea">
                    <form id="addMemberForm" class="space-y-3">
                        <input type="text" id="newName" placeholder="Full Name" class="w-full p-3 bg-slate-50 border rounded-xl" required>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="text" id="newDist" placeholder="District" class="p-3 bg-slate-50 border rounded-xl" required>
                            <input type="text" id="newMandal" placeholder="Mandal" class="p-3 bg-slate-50 border rounded-xl" required>
                        </div>
                        <input type="text" id="newPhone" placeholder="Mobile Number" class="w-full p-3 bg-slate-50 border rounded-xl" required>
                        <button type="submit" id="submitFormBtn" class="w-full bg-emerald-600 text-white font-black py-4 rounded-xl uppercase tracking-widest shadow-lg">Submit Record</button>
                        <button type="button" onclick="resetForm()" class="w-full text-[10px] font-bold text-slate-400 uppercase">Cancel / Clear</button>
                    </form>
                </div>
                <div id="adminLogArea" class="hidden max-h-60 overflow-y-auto text-[10px] space-y-2">
                    <p class="italic text-slate-400">All actions are recorded in the 'History' tab of the connected Google Sheet.</p>
                </div>
            </div>
        </div>
    </div>

    <main class="max-w-7xl mx-auto px-4 -mt-8 pb-20">
        <div class="bg-white p-6 rounded-2xl shadow-xl border border-slate-100 flex flex-wrap gap-4 mb-8">
            <input type="text" id="nameInput" onkeyup="searchSurveyors()" placeholder="Search Name/Mobile..." class="flex-1 min-w-[200px] p-4 border rounded-xl outline-none focus:ring-2 focus:ring-blue-900 bg-slate-50">
            <button onclick="exportToCSV()" class="bg-emerald-600 text-white font-black px-6 rounded-xl text-xs uppercase"><i class="fas fa-download mr-2"></i> Export</button>
        </div>

        <div class="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
            <table class="w-full text-left">
                <thead class="bg-slate-50 border-b font-black text-[10px] text-slate-400 uppercase tracking-widest">
                    <tr>
                        <th class="px-8 py-5">Surveyor</th>
                        <th class="px-8 py-5 hidden md:table-cell">Jurisdiction</th>
                        <th class="px-8 py-5 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody id="memberTable" class="divide-y divide-slate-100"></tbody>
            </table>
        </div>
    </main>

    <div id="printSection" class="hidden p-16 bg-white border-[20px] border-double border-blue-900">
        <div class="text-center border-b-4 border-orange-500 pb-10 mb-10">
            <h1 class="text-4xl font-black text-blue-900 uppercase tracking-tighter">Membership Verification</h1>
            <p class="text-sm font-bold text-slate-500 uppercase tracking-[0.5em] mt-2">Telangana State Licensed Surveyors Association</p>
        </div>
        <div class="grid grid-cols-3 gap-10">
            <div class="col-span-2 space-y-8">
                <div>
                    <label class="text-[10px] font-black text-slate-300 uppercase tracking-[0.2em]">Registered Professional</label>
                    <h2 id="printName" class="text-5xl font-black text-slate-900 uppercase"></h2>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-black text-slate-300 uppercase">Current Status</label>
                        <p class="text-2xl font-bold text-emerald-600 uppercase">‚óè Active Member</p>
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-300 uppercase">Date of Issue</label>
                        <p id="printDate" class="text-2xl font-bold text-slate-700"></p>
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-300 uppercase">Valid Jurisdiction</label>
                    <p class="text-2xl font-black text-slate-800 uppercase"><span id="printMandal"></span>, <span id="printDist"></span></p>
                </div>
            </div>
            <div class="flex flex-col items-center justify-center border-l-2 pl-10">
                <div id="qrcode"></div>
                <p class="text-[9px] font-black text-center text-blue-900 uppercase mt-4 tracking-widest leading-tight">Secure Digital<br>Authentication</p>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURATION
        const MASTER_PASS = "TSLSA2025"; 
        const SCRIPT_URL = 'YOUR_GOOGLE_APPS_SCRIPT_URL'; 
        const SHEET_CSV = 'https://docs.google.com/spreadsheets/d/1GTQ3JvpM3f6VeEvAjFzQtXAFSwXSU-M8ZAuBRrUuic8/export?format=csv';

        let surveyors = [];
        let isAdmin = false;
        let currentEditId = null;

        // AUTH & TABS
        function openAuth() { 
            if(isAdmin) { switchTab('form'); document.getElementById('adminModal').classList.remove('hidden'); }
            else { document.getElementById('adminModal').classList.remove('hidden'); document.getElementById('authStep').classList.remove('hidden'); }
        }
        function closeModal() { document.getElementById('adminModal').classList.add('hidden'); }
        
        function verifyPassword() {
            if(document.getElementById('staffPass').value === MASTER_PASS) {
                isAdmin = true;
                document.getElementById('authStep').classList.add('hidden');
                document.getElementById('entryStep').classList.remove('hidden');
                document.getElementById('modeIndicator').innerText = "System Administrator Mode Active";
                document.getElementById('loginBtn').innerText = "Admin Panel";
                renderTable(surveyors);
            } else { alert("Invalid Credentials"); }
        }

        function switchTab(tab) {
            const isForm = tab === 'form';
            document.getElementById('adminFormArea').classList.toggle('hidden', !isForm);
            document.getElementById('adminLogArea').classList.toggle('hidden', isForm);
            document.getElementById('tabBtnForm').className = isForm ? "flex-1 pb-3 border-b-2 border-blue-900" : "flex-1 pb-3 border-b-2 border-transparent text-slate-400";
            document.getElementById('tabBtnLog').className = !isForm ? "flex-1 pb-3 border-b-2 border-blue-900" : "flex-1 pb-3 border-b-2 border-transparent text-slate-400";
        }

        // DATA CORE
        async function loadData() {
            const table = document.getElementById('memberTable');
            table.innerHTML = `<tr><td colspan="3" class="p-20 text-center font-black text-slate-300 uppercase animate-pulse">Syncing Database...</td></tr>`;
            try {
                const res = await fetch(SHEET_CSV);
                const csv = await res.text();
                const rows = csv.split('\n').slice(1);
                surveyors = rows.map(r => {
                    const c = r.split(',');
                    return { id: c[0]?.trim(), name: c[1]?.trim(), dist: c[2]?.trim(), mandal: c[3]?.trim(), phone: c[5]?.trim() };
                }).filter(s => s.name);
                renderTable(surveyors);
            } catch(e) { table.innerHTML = "Error loading data."; }
        }

        function renderTable(data) {
            document.getElementById('memberTable').innerHTML = data.map(s => `
                <tr class="hover:bg-slate-50 transition">
                    <td class="px-8 py-6">
                        <div class="font-black text-slate-800 uppercase">${s.name}</div>
                        <div class="text-[10px] font-bold text-blue-900 opacity-60">MOB: ${s.phone}</div>
                    </td>
                    <td class="px-8 py-6 hidden md:table-cell">
                        <div class="text-sm font-bold text-slate-600 uppercase">${s.mandal}</div>
                        <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">${s.dist}</div>
                    </td>
                    <td class="px-8 py-6 text-right space-x-2">
                        ${isAdmin ? `
                            <button onclick="startEdit('${s.id}','${s.name}','${s.dist}','${s.mandal}','${s.phone}')" class="text-blue-500 p-2 hover:bg-blue-50 rounded-lg"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteMember('${s.id}')" class="text-red-500 p-2 hover:bg-red-50 rounded-lg"><i class="fas fa-trash"></i></button>
                        ` : `
                            <button onclick="printID('${s.id}')" class="bg-slate-100 p-3 rounded-xl hover:bg-blue-900 hover:text-white transition"><i class="fas fa-print"></i></button>
                        `}
                    </td>
                </tr>
            `).join('');
        }

        // CRUD ACTIONS
        async function deleteMember(id) {
            if(!confirm("Permanent Delete?")) return;
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "delete", id: id }) });
            location.reload();
        }

        function startEdit(id, name, dist, mandal, phone) {
            currentEditId = id;
            document.getElementById('newName').value = name;
            document.getElementById('newDist').value = dist;
            document.getElementById('newMandal').value = mandal;
            document.getElementById('newPhone').value = phone;
            document.getElementById('submitFormBtn').innerText = "Update Record";
            document.getElementById('submitFormBtn').classList.replace('bg-emerald-600', 'bg-blue-600');
            openAuth();
        }

        function resetForm() {
            currentEditId = null;
            document.getElementById('addMemberForm').reset();
            document.getElementById('submitFormBtn').innerText = "Submit Record";
            document.getElementById('submitFormBtn').classList.replace('bg-blue-600', 'bg-emerald-600');
        }

        document.getElementById('addMemberForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                action: currentEditId ? "edit" : null,
                id: currentEditId,
                name: document.getElementById('newName').value,
                district: document.getElementById('newDist').value,
                mandal: document.getElementById('newMandal').value,
                phone: document.getElementById('newPhone').value
            };
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            location.reload();
        });

        // UTILITIES
        function searchSurveyors() {
            const q = document.getElementById('nameInput').value.toLowerCase();
            renderTable(surveyors.filter(s => s.name.toLowerCase().includes(q) || s.phone.includes(q)));
        }

        function printID(id) {
            const s = surveyors.find(x => x.id === id);
            document.getElementById('printName').innerText = s.name;
            document.getElementById('printMandal').innerText = s.mandal;
            document.getElementById('printDist').innerText = s.dist;
            document.getElementById('printDate').innerText = new Date().toLocaleDateString();
            const qr = document.getElementById("qrcode");
            qr.innerHTML = "";
            new QRCode(qr, { text: window.location.href.split('?')[0] + "?id=" + s.id, width: 150, height: 150, colorDark: "#002147" });
            setTimeout(() => window.print(), 500);
        }

        function exportToCSV() {
            let csv = "ID,Name,District,Mandal,Phone\n" + surveyors.map(s => `${s.id},${s.name},${s.dist},${s.mandal},${s.phone}`).join("\n");
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', 'TSLSA_Registry.csv');
            a.click();
        }

        loadData();
    </script>
</body>
</html>
